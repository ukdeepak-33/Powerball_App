{% extends "base.html" %}

{% block title %}Sum of Main Balls Analysis{% endblock %}

{% block page_heading %}Sum of Main Balls Analysis{% endblock %}

{% block content %}
<div class="space-y-8">
    <div class="card p-6 bg-white rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Summary of White Ball Sums</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
            <div class="bg-gray-100 p-4 rounded-lg">
                <p class="text-sm font-semibold text-gray-600">Minimum Sum:</p>
                <p class="text-2xl font-bold text-gray-900">{{ min_sum }}</p>
            </div>
            <div class="bg-gray-100 p-4 rounded-lg">
                <p class="text-sm font-semibold text-gray-600">Maximum Sum:</p>
                <p class="text-2xl font-bold text-gray-900">{{ max_sum }}</p>
            </div>
            <div class="bg-gray-100 p-4 rounded-lg">
                <p class="text-sm font-semibold text-gray-600">Average Sum:</p>
                <p class="text-2xl font-bold text-gray-900">{{ avg_sum }}</p>
            </div>
        </div>
    </div>

    <div class="card p-6 bg-white rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Distribution of White Ball Sums</h2>
        <p class="text-gray-700 mb-4">This bar chart shows the frequency of each possible sum of the five white balls.</p>
        <div class="relative h-96 w-full">
            <canvas id="sumFrequencyChart"></canvas>
        </div>
    </div>

    <div class="card p-6 bg-white rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Historical Sum Data</h2>
        <p class="text-gray-700 mb-4">Click on the "Draw Date" or "Sum" headers to sort the table.</p>
        {% if sums_data %}
            <div class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors duration-150" data-sort-by="Draw Date" data-sort-dir="desc" id="draw-date-header">
                                Draw Date
                                <span class="sort-icon ml-1"></span>
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Number 1</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Number 2</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Number 3</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Number 4</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Number 5</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Powerball</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors duration-150" data-sort-by="Sum" data-sort-dir="asc" id="sum-header">
                                Sum
                                <span class="sort-icon ml-1"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="historical-sum-table-body" class="bg-white divide-y divide-gray-200">
                        {# Data will be rendered here by JavaScript #}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800">
                No sum data available.
            </div>
        {% endif %}
    </div>
</div>

<style>
    /* Styles for sort icons */
    .sort-icon {
        display: inline-block;
        width: 0;
        height: 0;
        vertical-align: middle;
        margin-left: 0.25rem;
    }
    .sort-icon.asc {
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-bottom: 5px solid #6b7280; /* Gray-500 */
    }
    .sort-icon.desc {
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 5px solid #6b7280; /* Gray-500 */
    }
    /* Small ball styling for tables */
    .ball-sm {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        width: 30px; /* Smaller size */
        height: 30px; /* Smaller size */
        background-color: #f0f0f0;
        border-radius: 50%;
        border: 1px solid #ccc;
        font-weight: bold;
        color: #333;
        margin: 2px;
        font-size: 0.8em; /* Smaller font */
    }
    .powerball-sm {
        background-color: #ef4444; /* Red color for powerball */
        color: white;
        border-color: #dc2626;
    }
</style>

{% block scripts %}
{{ super() }} {# Keep existing scripts from base.html #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Parse data passed from Flask
        const sumFreqData = {{ sum_freq_json | safe }};
        // Ensure historicalSumData uses original array directly or is converted properly
        const historicalSumData = {{ sums_data | tojson }};

        const historicalSumTableBody = document.getElementById('historical-sum-table-body');
        const drawDateHeader = document.getElementById('draw-date-header');
        const sumHeader = document.getElementById('sum-header');
        
        let currentSortBy = 'Draw Date'; // Default initial sort for the table
        let currentSortDir = 'desc';    // Default initial direction for draw date

        // Function to render the historical sums table
        function renderHistoricalSumTable(data) {
            historicalSumTableBody.innerHTML = ''; // Clear existing rows
            if (!data || data.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `<td colspan="8" class="px-4 py-2 text-center text-gray-600">No historical sum data available.</td>`;
                historicalSumTableBody.appendChild(noDataRow);
                return;
            }

            data.forEach(draw => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2 border-b border-gray-200 text-sm text-gray-900">${draw['Draw Date']}</td>
                    <td class="px-4 py-2 border-b border-gray-200 text-sm text-gray-900">
                        <span class="ball-sm">${draw['Number 1']}</span>
                        <span class="ball-sm">${draw['Number 2']}</span>
                        <span class="ball-sm">${draw['Number 3']}</span>
                        <span class="ball-sm">${draw['Number 4']}</span>
                        <span class="ball-sm">${draw['Number 5']}</span>
                    </td>
                    <td class="px-4 py-2 border-b border-gray-200 text-sm text-gray-900">
                        <span class="ball-sm powerball-sm">${draw.Powerball}</span>
                    </td>
                    <td class="px-4 py-2 border-b border-gray-200 text-sm text-gray-900">${draw.Sum}</td>
                `;
                historicalSumTableBody.appendChild(row);
            });
        }

        // Function to update sort icons in headers
        function updateSortIcons() {
            // Reset all icons
            const allHeaders = document.querySelectorAll('#draw-date-header, #sum-header');
            allHeaders.forEach(header => {
                const icon = header.querySelector('.sort-icon');
                if (icon) {
                    icon.classList.remove('asc', 'desc');
                }
            });

            // Update icon for the currently sorted column
            const currentHeader = document.getElementById(currentSortBy === 'Draw Date' ? 'draw-date-header' : 'sum-header');
            if (currentHeader) {
                const icon = currentHeader.querySelector('.sort-icon');
                if (icon) {
                    icon.classList.add(currentSortDir);
                }
            }
        }

        // Function to sort data and re-render table
        function sortAndRenderHistoricalSumData() {
            // Create a mutable copy of the data for sorting
            const sortableData = [...historicalSumData]; 

            sortableData.sort((a, b) => {
                let valA, valB;

                if (currentSortBy === 'Draw Date') {
                    // Convert date strings to Date objects for proper comparison
                    valA = new Date(a['Draw Date']);
                    valB = new Date(b['Draw Date']);
                } else if (currentSortBy === 'Sum') {
                    valA = a.Sum;
                    valB = b.Sum;
                }

                if (valA < valB) {
                    return currentSortDir === 'asc' ? -1 : 1;
                }
                if (valA > valB) {
                    return currentSortDir === 'asc' ? 1 : -1;
                }
                return 0;
            });
            renderHistoricalSumTable(sortableData);
            updateSortIcons();
        }

        // Event Listeners for table headers
        if (drawDateHeader) {
            drawDateHeader.addEventListener('click', function() {
                if (currentSortBy === 'Draw Date') {
                    currentSortDir = (currentSortDir === 'asc' ? 'desc' : 'asc');
                } else {
                    currentSortBy = 'Draw Date';
                    currentSortDir = 'desc'; // Default to descending for dates
                }
                sortAndRenderHistoricalSumData();
            });
        }

        if (sumHeader) {
            sumHeader.addEventListener('click', function() {
                if (currentSortBy === 'Sum') {
                    currentSortDir = (currentSortDir === 'asc' ? 'desc' : 'asc');
                } else {
                    currentSortBy = 'Sum';
                    currentSortDir = 'asc'; // Default to ascending for sums
                }
                sortAndRenderHistoricalSumData();
            });
        }

        // --- Chart.js for Sum Frequency (existing code from your provided template) ---
        if (sumFreqData && sumFreqData.length > 0) {
            const labels = sumFreqData.map(d => d.sum);
            const data = sumFreqData.map(d => d.count);

            const ctx = document.getElementById('sumFrequencyChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Frequency',
                            data: data,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)', // Teal-like color
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Draws'
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Sum of White Balls'
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            }
        }
        
        // Initial render of the historical sum table with default sort (Draw Date Desc)
        sortAndRenderHistoricalSumData();
    });
</script>
{% endblock %}

