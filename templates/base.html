<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Powerball Analysis{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            padding: 1.5rem; /* p-6 */
        }
        .btn-primary {
            display: inline-block;
            background-color: #4f46e5; /* indigo-600 */
            color: #ffffff;
            padding: 0.5rem 1rem; /* py-2 px-4 */
            border-radius: 0.5rem; /* rounded-md */
            font-weight: 600; /* font-semibold */
            text-align: center;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4b5563; /* gray-700 */
        }
        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* ring-indigo-200 */
        }
        .table-auto {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .table-auto th, .table-auto td {
            border: 1px solid #e5e7eb; /* gray-200 */
            padding: 0.75rem;
            text-align: left;
        }
        .table-auto th {
            background-color: #f9fafb; /* gray-50 */
            font-weight: 600;
            color: #4b5563; /* gray-700 */
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        .table-auto tbody tr:nth-child(even) {
            background-color: #f3f4f6; /* gray-100 */
        }
        .table-auto tbody tr:hover {
            background-color: #e5e7eb; /* gray-200 */
        }

        /* D3 Chart Specific Styles */
        .chart-container {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            position: relative; /* Needed for tooltips */
        }
        .chart-container svg {
            width: 100%;
            height: auto; /* Allow D3 to manage height dynamically, or set min-height */
        }

        /* Tooltip styles */
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            font: 12px sans-serif;
            background: #333;
            color: #fff;
            border: 0px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000; /* Ensure tooltip is on top */
        }

        /* Bar chart specific styles */
        .bar {
            shape-rendering: crispEdges; /* Ensures sharp edges for bars */
        }

        .axis text {
            font-size: 10px;
            fill: #6b7280; /* gray-500 */
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: #d1d5db; /* gray-300 */
            shape-rendering: crispEdges;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <header class="bg-indigo-600 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
            <a href="{{ url_for('index') }}" class="text-2xl font-bold mb-3 sm:mb-0">Powerball Insight</a>
            <ul class="flex flex-wrap justify-center sm:justify-end gap-x-4 gap-y-2">
                <li><a href="{{ url_for('index') }}" class="block py-1 px-2 text-sm text-indigo-200 hover:bg-indigo-700 rounded transition-colors duration-200">Home</a></li>
                <li><a href="{{ url_for('winning_probability_route') }}" class="block py-1 px-2 text-sm text-indigo-200 hover:bg-indigo-700 rounded transition-colors duration-200">Winning Probability</a></li>
                <li><a href="{{ url_for('partial_match_probabilities_route') }}" class="block py-1 px-2 text-sm text-indigo-200 hover:bg-indigo-700 rounded transition-colors duration-200">Partial Match Odds</a></li>
                <li><a href="{{ url_for('hot_cold_numbers_route') }}" class="block py-1 px-2 text-sm text-indigo-200 hover:bg-indigo-700 rounded transition-colors duration-200">Hot & Cold Numbers</a></li>
                <li><a href="{{ url_for('sum_of_main_balls_route') }}" class="block py-1 px-2 text-sm text-indigo-200 hover:bg-indigo-700 rounded transition-colors duration-200">Sum of Main Balls</a></li>
                <li><a href="{{ url_for('co_occurrence_analysis_route') }}" class="block py-1 px-2 text-sm text-indigo-200 hover:bg-indigo-700 rounded transition-colors duration-200">Co-occurrence Heatmap</a></li>
                <li><a href="{{ url_for('monthly_white_ball_analysis_route') }}" class="block py-1 px-2 text-sm text-indigo-200 hover:bg-indigo-700 rounded transition-colors duration-200">Monthly Analysis</a></li>
                <li><a href="{{ url_for('number_age_distribution_route') }}" class="block py-1 px-2 text-sm text-indigo-200 hover:bg-indigo-700 rounded transition-colors duration-200">Number Age Dist.</a></li>
                <li><a href="{{ url_for('powerball_position_frequency_route') }}" class="block py-1 px-2 text-sm text-indigo-200 hover:bg-indigo-700 rounded transition-colors duration-200">Powerball Position Freq.</a></li>
                <li><a href="{{ url_for('find_results_by_sum_route') }}" class="block py-1 px-2 text-sm text-indigo-200 hover:bg-indigo-700 rounded transition-colors duration-200">Find by Sum</a></li>
                <li><a href="{{ url_for('find_results_by_first_white_ball') }}" class="block py-1 px-2 text-sm text-indigo-200 hover:bg-indigo-700 rounded transition-colors duration-200">Find by First Ball</a></li>
                <li><a href="{{ url_for('export_analysis_results_route') }}" class="block py-1 px-2 text-sm text-indigo-200 hover:bg-indigo-700 rounded transition-colors duration-200">Export Results</a></li>
                 <li><a href="{{ url_for('simulate_multiple_draws_route') }}" class="block py-1 px-2 text-sm text-indigo-200 hover:bg-indigo-700 rounded transition-colors duration-200">Simulate Draw</a></li>
                <li><a href="{{ url_for('update_powerball_data') }}" class="block py-1 px-2 text-sm text-indigo-200 hover:bg-indigo-700 rounded transition-colors duration-200">Update Data</a></li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center">
            {% block page_heading %}{% endblock %}
        </h1>
        {% block content %}{% endblock %}
    </main>

    <footer class="bg-gray-800 text-white py-6 mt-auto">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; {{ now.year if now else '2023' }} Powerball Insight. All rights reserved.</p>
        </div>
    </footer>

    {% block scripts %}
    <!-- Common D3 drawing functions will go here or in a separate JS file -->
    <script>
        // Function to draw a generic bar chart
        function drawBarChart(data, elementId, xKey, yKey, title, xLabel, yLabel, barColor) {
            if (!data || data.length === 0) {
                d3.select(\`#\${elementId}\`).html("<p class='text-gray-500'>No data available for this chart.</p>");
                console.warn(\`No data provided for bar chart: \${elementId}\`);
                return;
            }

            const margin = {top: 40, right: 30, bottom: 60, left: 70};
            const container = d3.select(\`#\${elementId}\`);
            const containerWidth = container.node().getBoundingClientRect().width;
            const width = containerWidth - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom; // Fixed height for consistency

            container.selectAll("svg").remove(); // Clear any existing SVG

            const svg = container.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", \`translate(\${margin.left},\${margin.top})\`);

            // Create scales
            const x = d3.scaleBand()
                .domain(data.map(d => d[xKey]))
                .range([0, width])
                .padding(0.2);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d[yKey]) * 1.05]) // 5% buffer at the top
                .range([height, 0]);

            // Add X axis
            svg.append("g")
                .attr("transform", \`translate(0,\${height})\`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

            // Add Y axis
            svg.append("g")
                .call(d3.axisLeft(y));

            // Add bars
            svg.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d[xKey]))
                .attr("y", d => y(d[yKey]))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d[yKey]))
                .attr("fill", barColor);

            // Add X axis label
            svg.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .text(xLabel)
                .style("font-size", "14px")
                .style("fill", "#333");

            // Add Y axis label
            svg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "middle")
                .attr("y", -margin.left + 20)
                .attr("x", -height / 2)
                .attr("transform", "rotate(-90)")
                .text(yLabel)
                .style("font-size", "14px")
                .style("fill", "#333");

            // Add chart title
            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-weight", "bold")
                .style("fill", "#333")
                .text(title);
        }

        // Function to draw a heatmap
        function drawHeatmap(data, elementId, xKey, yKey, valueKey, title, xLabel, yLabel, maxValue) {
            if (!data || data.length === 0) {
                d3.select(\`#\${elementId}\`).html("<p class='text-gray-500'>No data available for this chart.</p>");
                console.warn(\`No data provided for heatmap: \${elementId}\`);
                return;
            }

            // Extract unique x and y values for the axes
            const xDomain = Array.from(new Set(data.map(d => d[xKey]))).sort(d3.ascending);
            const yDomain = Array.from(new Set(data.map(d => d[yKey]))).sort(d3.ascending);

            const margin = {top: 50, right: 30, bottom: 80, left: 80}; // Increased margins for labels
            const container = d3.select(\`#\${elementId}\`);
            const containerWidth = container.node().getBoundingClientRect().width;
            const width = containerWidth - margin.left - margin.right;
            const height = Math.min(width, 600) - margin.top - margin.bottom; // Make it more square-ish and responsive

            container.selectAll("svg").remove(); // Clear any existing SVG

            const svg = container.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", \`translate(\${margin.left},\${margin.top})\`);

            // Build X scales and axis:
            const x = d3.scaleBand()
                .range([ 0, width ])
                .domain(xDomain)
                .padding(0.01);

            svg.append("g")
                .attr("transform", \`translate(0,\${height})\`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            // Build Y scales and axis:
            const y = d3.scaleBand()
                .range([ height, 0 ])
                .domain(yDomain)
                .padding(0.01);

            svg.append("g")
                .call(d3.axisLeft(y));

            // Build color scale
            const colorScale = d3.scaleSequential(d3.interpolateViridis) // Or d3.interpolateGreens, d3.interpolateBlues
                .domain([0, maxValue || d3.max(data, d => d[valueKey])]); // Use maxValue if provided, else compute

            // Create a tooltip div
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Add the squares
            svg.selectAll()
                .data(data, d => \`\${d[xKey]}:\${d[yKey]}\`)
                .enter()
                .append("rect")
                .attr("x", d => x(d[xKey]))
                .attr("y", d => y(d[yKey]))
                .attr("width", x.bandwidth())
                .attr("height", y.bandwidth())
                .style("fill", d => colorScale(d[valueKey]))
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(\`Ball 1: \${d[xKey]}<br/>Ball 2: \${d[yKey]}<br/>Count: \${d[valueKey]}\`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add X axis label
            svg.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .text(xLabel)
                .style("font-size", "14px")
                .style("fill", "#333");

            // Add Y axis label
            svg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "middle")
                .attr("y", -margin.left + 20)
                .attr("x", -height / 2)
                .attr("transform", "rotate(-90)")
                .text(yLabel)
                .style("font-size", "14px")
                .style("fill", "#333");

            // Add chart title
            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-weight", "bold")
                .style("fill", "#333")
                .text(title);
        }

        // Function to draw pie/donut chart for age distribution
        function drawPieChart(data, elementId, valueKey, labelKey, title) {
            if (!data || data.length === 0) {
                d3.select(\`#\${elementId}\`).html("<p class='text-gray-500'>No data available for this chart.</p>");
                console.warn(\`No data provided for pie chart: \${elementId}\`);
                return;
            }

            const width = 400;
            const height = 400;
            const radius = Math.min(width, height) / 2;

            const container = d3.select(\`#\${elementId}\`);
            container.selectAll("svg").remove(); // Clear any existing SVG

            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", \`translate(\${width / 2},\${height / 2})\`);

            const color = d3.scaleOrdinal(d3.schemeCategory10);

            const pie = d3.pie()
                .value(d => d[valueKey])
                .sort(null);

            const arc = d3.arc()
                .innerRadius(0) // For pie chart, innerRadius is 0. For donut, set a value like radius * 0.4
                .outerRadius(radius);

            const arcs = svg.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.data[labelKey]));

            arcs.append("text")
                .attr("transform", d => \`translate(\${arc.centroid(d)})\`)
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .text(d => d.data[labelKey])
                .style("font-size", "12px")
                .style("fill", "white")
                .style("text-shadow", "1px 1px 2px black"); // Add text shadow for readability

            // Add chart title
            svg.append("text")
                .attr("x", 0)
                .attr("y", -radius - 20) // Position above the chart
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-weight", "bold")
                .style("fill", "#333")
                .text(title);
        }

        // Function to handle automatic resizing of D3 charts
        function setupChartResizeListener(chartFunction, data, elementId, ...args) {
            window.addEventListener('resize', () => {
                // Throttle resize events for performance
                if (this.resizeTimer) {
                    clearTimeout(this.resizeTimer);
                }
                this.resizeTimer = setTimeout(() => {
                    chartFunction(data, elementId, ...args);
                }, 250); // Redraw after 250ms of no resizing
            });
        }

    </script>
    {% endblock %}
</body>
</html>
