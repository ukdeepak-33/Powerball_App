<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Powerball Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f4f8;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            position: fixed;
            height: 100%;
            overflow-y: auto;
        }
        .content {
            margin-left: 270px; /* Adjust based on sidebar width + padding */
            padding: 20px;
        }
        .sidebar a {
            display: block;
            padding: 10px 15px;
            color: #ecf0f1;
            text-decoration: none;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: background-color 0.3s ease;
        }
        .sidebar a:hover {
            background-color: #34495e;
        }
        .sidebar .current-page {
            background-color: #1abc9c;
            font-weight: bold;
        }
        .flash-message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .flash-message.error {
            background-color: #e74c3c;
            color: white;
        }
        .flash-message.info {
            background-color: #3498db;
            color: white;
        }
        /* Chart specific styles */
        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: #ddd;
            shape-rendering: crispEdges;
        }
        .axis text {
            font-family: sans-serif;
            font-size: 10px;
        }
        .x-axis-label, .y-axis-label {
            font-size: 12px;
            font-weight: bold;
        }
        .bar {
            fill: steelblue;
        }
        .bar:hover {
            fill: lightblue;
        }
        .label {
            font-size: 10px;
            fill: #333;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: 120px;
            height: 28px;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
        .heatmap-cell {
            stroke: #ccc;
            stroke-width: 0.5px;
        }
        .heatmap-tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            font-family: sans-serif;
            font-size: 12px;
        }
    </style>
</head>
<body class="flex">
    <div class="sidebar">
        <h2 class="text-2xl font-bold mb-6 text-center">Powerball Analyzer</h2>
        <nav>
            <ul>
                <li><a href="{{ url_for('index') }}" class="{% if request.path == '/' %}current-page{% endif %}">Home</a></li>
                <li><a href="{{ url_for('frequency_analysis_route') }}" class="{% if request.path == '/frequency_analysis' %}current-page{% endif %}">Frequency Analysis</a></li>
                <li><a href="{{ url_for('hot_cold_numbers_route') }}" class="{% if request.path == '/hot_cold_numbers' %}current-page{% endif %}">Hot & Cold Numbers</a></li>
                <li><a href="{{ url_for('monthly_white_ball_analysis_route') }}" class="{% if request.path == '/monthly_white_ball_analysis' %}current-page{% endif %}">Monthly Ball Analysis</a></li>
                <li><a href="{{ url_for('sum_of_main_balls_route') }}" class="{% if request.path == '/sum_of_main_balls' %}current-page{% endif %}">Sum of Main Balls</a></li>
                <li><a href="{{ url_for('find_results_by_sum_route') }}" class="{% if request.path == '/find_results_by_sum' %}current-page{% endif %}">Find by Sum</a></li>
                <li><a href="{{ url_for('simulate_multiple_draws_route') }}" class="{% if request.path == '/simulate_multiple_draws' %}current-page{% endif %}">Simulate Draws</a></li>
                <li><a href="{{ url_for('winning_probability_route') }}" class="{% if request.path == '/winning_probability' %}current-page{% endif %}">Winning Probability</a></li>
                <li><a href="{{ url_for('partial_match_probabilities_route') }}" class="{% if request.path == '/partial_match_probabilities' %}current-page{% endif %}">Partial Match Probabilities</a></li>
                <li><a href="{{ url_for('number_age_distribution_route') }}" class="{% if request.path == '/number_age_distribution' %}current-page{% endif %}">Number Age Distribution</a></li>
                <li><a href="{{ url_for('co_occurrence_analysis_route') }}" class="{% if request.path == '/co_occurrence_analysis' %}current-page{% endif %}">Co-occurrence Analysis</a></li>
                <li><a href="{{ url_for('powerball_position_frequency_route') }}" class="{% if request.path == '/powerball_position_frequency' %}current-page{% endif %}">Powerball Position Freq</a></li>
                <li><a href="{{ url_for('find_results_by_first_white_ball') }}" class="{% if request.path == '/find_results_by_first_white_ball' %}current-page{% endif %}">Find by First Ball</a></li>
            </ul>
        </nav>
    </div>

    <div class="content flex-1">
        <div class="container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <ul class="not-prose">
                        {% for category, message in messages %}
                            <li class="flash-message {{ category }}">{{ message }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            {% endwith %}

            {% block content %}{% endblock %}
        </div>
    </div>

    <script>
        // Global D3 functions for reusability
        function drawBarChart(data, elementId, xKey, yKey, chartTitle, xLabel, yLabel, barColor = "steelblue", tooltipPrefix = "") {
            console.log(`[D3 Debug] drawBarChart called for ${elementId}`);
            console.log("[D3 Debug] Data received for bar chart:", data);

            if (!data || data.length === 0) {
                console.warn(`[D3 Warn] No data provided for bar chart: ${elementId}`);
                d3.select(`#${elementId}`).html("<p>No data available for this chart.</p>");
                return;
            }

            // Clear previous chart
            d3.select(`#${elementId}`).html("");

            const margin = { top: 40, right: 30, bottom: 60, left: 50 },
                  width = 700 - margin.left - margin.right,
                  height = 400 - margin.top - margin.bottom;

            const svg = d3.select(`#${elementId}`)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .padding(0.1);

            const y = d3.scaleLinear()
                .range([height, 0]);

            x.domain(data.map(d => d[xKey]));
            y.domain([0, d3.max(data, d => d[yKey])]);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

            svg.append("g")
                .call(d3.axisLeft(y));

            // X-axis label
            svg.append("text")
                .attr("class", "x-axis-label")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .style("text-anchor", "middle")
                .text(xLabel);

            // Y-axis label
            svg.append("text")
                .attr("class", "y-axis-label")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left + 10)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text(yLabel);

            // Title
            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-weight", "bold")
                .text(chartTitle);

            // Tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0)
                .style("position", "absolute")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "1px")
                .style("border-radius", "5px")
                .style("padding", "10px");

            svg.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d[xKey]))
                .attr("y", d => y(d[yKey]))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d[yKey]))
                .attr("fill", barColor)
                .on("mouseover", (event, d) => {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`${tooltipPrefix}${d[xKey]}: ${d[yKey]}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });
        }


        function drawHeatmap(data, elementId, xKey, yKey, countKey, chartTitle, xLabel, yLabel, maxCount = 0) {
            console.log(`[D3 Debug] drawHeatmap called for ${elementId}`);
            console.log("[D3 Debug] Data received for heatmap:", data);

            if (!data || data.length === 0) {
                console.warn(`[D3 Warn] No data provided for heatmap: ${elementId}`);
                d3.select(`#${elementId}`).html("<p>No data available for this chart.</p>");
                return;
            }

            // Clear previous chart
            d3.select(`#${elementId}`).html("");

            const margin = { top: 50, right: 30, bottom: 50, left: 50 },
                  width = 800 - margin.left - margin.right,
                  height = 600 - margin.top - margin.bottom;

            const svg = d3.select(`#${elementId}`)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Extract unique x and y values for domains
            const xDomain = Array.from(new Set(data.map(d => d[xKey]))).sort((a, b) => a - b);
            const yDomain = Array.from(new Set(data.map(d => d[yKey]))).sort((a, b) => a - b);

            const x = d3.scaleBand()
                .range([0, width])
                .domain(xDomain)
                .padding(0.01);

            const y = d3.scaleBand()
                .range([height, 0])
                .domain(yDomain)
                .padding(0.01);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));

            svg.append("g")
                .call(d3.axisLeft(y));

            // X-axis label
            svg.append("text")
                .attr("class", "x-axis-label")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .style("text-anchor", "middle")
                .text(xLabel);

            // Y-axis label
            svg.append("text")
                .attr("class", "y-axis-label")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left + 10)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text(yLabel);

            // Title
            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-weight", "bold")
                .text(chartTitle);

            // Color scale
            const colorMax = maxCount > 0 ? maxCount : d3.max(data, d => d[countKey]);
            const colorScale = d3.scaleSequential(d3.interpolateViridis)
                                 .domain([0, colorMax]);

            // Tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "heatmap-tooltip")
                .style("opacity", 0);

            svg.selectAll(".heatmap-cell")
                .data(data)
                .enter().append("rect")
                .attr("class", "heatmap-cell")
                .attr("x", d => x(d[xKey]))
                .attr("y", d => y(d[yKey]))
                .attr("width", x.bandwidth())
                .attr("height", y.bandwidth())
                .style("fill", d => colorScale(d[countKey]))
                .on("mouseover", (event, d) => {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`(${d[xKey]}, ${d[yKey]}): ${d[countKey]} occurrences`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });
        }
    </script>
</body>
</html>
